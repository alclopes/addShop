# Desafio 02.1 - Criando um hook de carrinho de compras
// Solu√ß√£o: https://www.youtube.com/watch?v=NTeUIfUtKWw

// tags: #JsonServer# #FakeApi# #LocalStorageApi# #toastify# #React#
#TypeScript# #StyledComponents# #Axios# #React-Toastify#

# Projeto - addShop

# üíª Sobre o desafio

Nesse¬†desafio,¬†voc√™¬†dever√°¬†criar¬†uma¬†aplica√ß√£o¬†para¬†treinar¬†o¬†que aprendeu¬†at√©¬†agora¬†no¬†ReactJS

Essa¬†ser√°¬†uma¬†aplica√ß√£o onde o seu principal objetivo √© criar um hook de carrinho de compras. Voc√™ ter√° acesso a duas p√°ginas, um componente e um hook para implementar as funcionalidades pedidas nesse desafio:

* **Funcionalidades**
- Adicionar um novo produto ao carrinho;
- Remover um produto do carrinho;
- Alterar a quantidade de um produto no carrinho;
- C√°lculo dos pre√ßos sub-total e total do carrinho;
- Valida√ß√£o de estoque;
- Exibi√ß√£o de mensagens de erro;
- Entre outros.

A seguir veremos com mais detalhes o que e como precisa ser feito üöÄ

## Template da aplica√ß√£o

Para te ajudar nesse desafio, criamos para voc√™ esse modelo que voc√™ deve utilizar como um template do GitHub.

O template est√° dispon√≠vel na seguinte URL: 

[GitHub - rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras)

**Dica**: Caso n√£o saiba utilizar reposit√≥rios do GitHub como template, temos um guia em **[nosso FAQ](https://www.notion.so/FAQ-Desafios-ddd8fcdf2339436a816a0d9e45767664).**

## Se preparando para o desafio

Para esse desafio, al√©m dos conceitos vistos em aula utilizaremos algumas coisa novas para deixar a nossa aplica√ß√£o ainda melhor. Por isso, antes de ir diretamente para o c√≥digo do desafio, explicaremos um pouquinho de:

- Fake API com JSON Server;
- Preservar dados do carrinho com localStorage API;
- Mostrar erros com toastify.

### Fake API com JSON Server

Assim como utilizamos o MirageJS no m√≥dulo 2 para simular uma API com os dados das transa√ß√µes da aplica√ß√£o dtmoney, vamos utilizar o JSON Server para simular uma API que possui as informa√ß√µes dos produtos e do estoque. 

Navegue at√© a pasta criada, abra no Visual Studio Code e execute os seguintes comandos no terminal:

```bash
yarn
yarn server
```

Em seguida, voc√™ vai ver a mensagem:

  dShop_React$ yarn server
  yarn run v1.22.5
  $ json-server server.json -p 3333

    \{^_^}/ hi!

    Loading server.json
    Done

    Resources
    http://localhost:3333/stock
    http://localhost:3333/products

    Home
    http://localhost:3333

Perceba que ele iniciou uma fake API com os recursos `/stock` e `/products` em `localhost` na porta `3333` a partir das informa√ß√µes do arquivo [server.json](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras/blob/master/server.json) localizado na raiz do seu projeto. 

Acessando essas rotas no seu navegador, voc√™ consegue ver o retorno das informa√ß√µes j√° em JSON:
![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0fe33995-e128-480c-aaf9-c8d77e0f5544/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0fe33995-e128-480c-aaf9-c8d77e0f5544/Untitled.png)
![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c89f74cb-4e41-4658-91d4-f8358a973088/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c89f74cb-4e41-4658-91d4-f8358a973088/Untitled.png)

Para acessar a listagem de todos os produtos e estoque, basta realizar uma requisi√ß√£o GET nas rotas `/products` e `/stock` respectivamente. Para acessar os dados de um √∫nico item utilize os `route params`, exemplo: `/products/1` e `/stock/1` para acessar os dados do produto e estoque do produto de id 1, respectivamente.

Dessa forma, basta consumir essas rotas da API normalmente com o axios. Caso queira estudar mais sobre o **JSON Server**, d√™ uma olhada aqui:

[typicode/json-server](https://github.com/typicode/json-server)

### Preservando carrinho com localStorage API 
// #LocalStorageApi#

Para preservar os dados do carrinho mesmo se fecharmos a aplica√ß√£o, utilizaremos a **localStorage API**

Essa √© uma API que nos permite persistir dados no navegador em um esquema de chave-valor (semelhante ao que temos com objetos JSON). Como essa √© uma API global, voc√™ n√£o precisa importar nada antes de usar. 

Para salvar os dados, voc√™ deve utilizar o m√©todo `setItem`. Como primeiro argumento voc√™ deve informar o nome que voc√™ quer dar para o registro, no caso desse desafio √© `obrigat√≥rio` utilizar o nome `@RocketShoes:cart`. J√° o segundo argumento √© o valor do registro que **obrigatoriamente** precisa estar no formato `string`.  Abaixo segue um exemplo:

```bash
localStorage.setItem('@RocketShoes:cart', cart)
```

Caso queira enviar um valor para o registro que n√£o esteja no formato `string`, √© preciso trat√°-lo (ex.: `JSON.stringify`). Isso far√° com que um objeto, lista, n√∫mero ou qualquer outro valor seja convertido para uma string.

Para recuperar os dados, voc√™ deve utilizar o m√©todo `getItem` passando como argumento do registro que, no caso desse desafio, √© `obrigat√≥rio` utilizar como `@RocketShoes:cart`. Abaixo segue um exemplo:

```jsx
const storagedCart = localStorage.getItem('@RocketShoes:cart');
```

O valor retornado pelo m√©todo `getItem` √© sempre no formato `string`. Caso voc√™ queira utilizar esse dado em outro formato, √© preciso trat√°-los (ex.: `JSON.parse`). Isso ir√° converter a informa√ß√£o ao estado original de quando foi salva com o `JSON.strigify`, seja uma lista, um objeto ou outro tipo de dado.

Caso queira estudar mais sobre a **localStorage API**, d√™ uma olhada aqui

[Window.localStorage](https://developer.mozilla.org/pt-BR/docs/Web/API/Window/localStorage)

### Mostrando erros com toastify
// #toastify#

Para mostrar os erros em tela, iremos utilizar um pacote chamado **react-toastify**. Ela ajuda a mostra informa√ß√µes tempor√°rias e r√°pidas de uma forma bem bonita.

De todos os m√©todos, utilizaremos apenas o `error` e ser√° obrigat√≥rio utilizar mensagens predefinidas para que os testes passem (veremos mais sobre isso)

Caso queira estudar mais sobre a **react-toastify**, d√™ uma olhada aqui

[fkhadra/react-toastify](https://github.com/fkhadra/react-toastify#readme)

## O que devo editar na aplica√ß√£o?

Com o template j√° clonado, as dep√™ndencias instaladas e a [fake API rodando](https://www.notion.so/Desafio-01-Criando-um-hook-de-carrinho-de-compras-5769216778794019a83f544e79167b12), voc√™ deve completar onde n√£o possui c√≥digo com o c√≥digo para atingir os objetivos de cada teste. Os documentos que devem ser editados s√£o:

- [src/components/Header/index.tsx](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras/blob/main/src/components/Header/index.tsx);
- [src/pages/Home/index.tsx](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras/blob/main/src/pages/Home/index.tsx)
- [src/pages/Cart/index.tsx](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras/blob/main/src/pages/Cart/index.tsx);
- [src/hooks/useCart.tsx](https://github.com/rocketseat-education/ignite-template-reactjs-criando-um-hook-de-carrinho-de-compras/blob/main/src/hooks/useCart.tsx).

### components/Header/index.tsx

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/71a7f217-c1bb-426a-8fcc-dfb65db6bb7a/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/71a7f217-c1bb-426a-8fcc-dfb65db6bb7a/Untitled.png)

Voc√™ deve receber o array `cart` do hook `useCart` e mostrar em tela a quantidade de produtos **distintos** adicionados ao carrinho. Dessa forma, se o carrinho possui 4 unidades do item A e 1 unidade do item B o valor a ser mostrado √© `2 itens`.

### pages/Home/index.tsx

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3d320e3c-a052-4f72-994e-aa69617ee85c/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3d320e3c-a052-4f72-994e-aa69617ee85c/Untitled.png)

Voc√™ deve renderizar os produtos buscados da fake API em tela com as informa√ß√µes de t√≠tulo, imagem, pre√ßo e quantidade adicionada ao carrinho. Por fim, √© preciso implementar a funcionalidade de adicionar o produto escolhido ao carrinho ao clicar no bot√£o `ADICIONAR AO CARRINHO`.

Nesse arquivo, temos tr√™s pontos importantes a serem implementados:

- **cartItemsAmount:** Deve possuir as informa√ß√µes da quantidade de cada produto no carrinho. Sugerimos criar um objeto utilizando `reduce` onde a chave representa o id do produto e o valor a quantidade do produto no carrinho. Exemplo: se voc√™ possuir no carrinho um produto de id 1 e quantidade 4 e outro produto de id 2 e quantidade 3, o objeto ficaria assim:

```jsx
{
	1: 4,
	2: 3
}
```

- **loadProducts:** Deve buscar os produtos da Fake API e formatar o pre√ßo utilizando o helper `utils/format`
- **handleAddProduct:** Deve adicionar o produto escolhido ao carrinho.

### pages/Cart/index.tsx

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a34120df-4046-4a84-8133-6eb987bceac6/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a34120df-4046-4a84-8133-6eb987bceac6/Untitled.png)

Voc√™ deve renderizar uma tabela com a imagem, t√≠tulo, pre√ßo unit√°rio, quantidade de unidades e pre√ßo subtotal de cada produto no carrinho. Al√©m disso, tamb√©m √© preciso renderizar o pre√ßo total do carrinho. Por fim, √© preciso implementar as funcionalidades dos bot√µes de decrementar, incrementar e remover o produto do carinho.

Nesse arquivo, temos cinco pontos importantes a serem implementados:

- **cartFormatted:** Deve formatar o carrinho adicionando os campos `priceFormatted` (pre√ßo do produto) e `subTotal` (pre√ßo do produto multiplicado pela quantidade) ambos devidamente formatados com o `utils/format`.
- **total:** Deve possuir a informa√ß√£o do valor total do carrinho devidamente formatado com o `utils/format`.
- **handleProductIncrement:** Deve aumentar em 1 unidade a quantidade do produto escolhido ao carrinho.
- **handleProductDecrement:** Deve diminuir em 1 unidade a quantidade do produto escolhido ao carrinho, onde o valor m√≠nimo √© 1 (nesse caso o bot√£o deve estar desativado).
- **handleRemoveProduct:** Deve remover o produto escolhido do carrinho.

### hooks/useCart.tsx

Apesar de n√£o retornar diretamente nenhuma renderiza√ß√£o de elementos na interface como os outros arquivos, esse √© o cora√ß√£o do desafio. Ele √© respons√°vel por:

- hook `useCart`;
- context `CartProvider`;
- manipular `localStorage`;
- exibir `toasts`.

Ent√£o √© aqui que voc√™ vai implementar as funcionalidades que ser√£o utilizadas pelo restante do app. Os principais pontos s√£o:

- **cart:** Deve verificar se existe algum registro com o valor `@RocketShoes:cart` e retornar esse valor caso existir. Caso contr√°rio, retornar um array vazio.
- **addProduct:** Deve adicionar um produto ao carrinho. Por√©m, √© preciso verificar algumas coisas:
    - O valor atualizado do carrinho deve ser perpetuado no **localStorage** utilizando o m√©todo `setItem`.
    - Caso o produto j√° exista no carrinho, n√£o se deve adicionar um novo produto repetido, apenas incrementar em 1 unidade a quantidade;
    - Verificar se existe no estoque a quantidade desejada do produto. Caso contr√°rio, utilizar o m√©todo `error` da **react-toastify** com a seguinte mensagem:

    ```jsx
    toast.error('Quantidade solicitada fora de estoque');
    ```

    - Capturar utilizando `trycatch` os erros que ocorrerem ao longo do m√©todo e, no catch, utilizar o m√©todo `error` da **react-toastify** com a seguinte mensagem:

    ```jsx
    toast.error('Erro na adi√ß√£o do produto');
    ```

- **removeProduct:** Deve remover um produto do carrinho. Por√©m, √© preciso verificar algumas coisas:
    - O valor atualizado do carrinho deve ser perpetuado no **localStorage** utilizando o m√©todo `setItem`.
    - Capturar utilizando `trycatch` os erros que ocorrerem ao longo do m√©todo e, no catch, utilizar o m√©todo `error` da **react-toastify** com a seguinte mensagem:

    ```jsx
    toast.error('Erro na remo√ß√£o do produto');
    ```

- **updateProductAmount:** Deve atualizar a quantidade de um produto no carrinho. Por√©m, √© preciso verificar algumas coisas:
    - O valor atualizado do carrinho deve ser perpetuado no **localStorage** utilizando o m√©todo `setItem`.
    - Se a quantidade do produto for menor ou igual a zero, sair da fun√ß√£o **updateProductAmount** instantaneamente.
    - Verificar se existe no estoque a quantidade desejada do produto. Caso contr√°rio, utilizar o m√©todo `error` da **react-toastify** com a seguinte mensagem:

    ```jsx
    toast.error('Quantidade solicitada fora de estoque');
    ```

    - Capturar utilizando `trycatch` os erros que ocorrerem ao longo do m√©todo e, no catch, utilizar o m√©todo `error` da **react-toastify** com a seguinte mensagem:

    ```jsx
    toast.error('Erro na altera√ß√£o de quantidade do produto');
    ```

## Especifica√ß√£o dos testes

Em¬†cada¬†teste,¬†tem¬†uma¬†breve¬†descri√ß√£o¬†no¬†que¬†sua¬†aplica√ß√£o¬†deve¬†cumprir¬†para¬†que¬†o¬†teste¬†passe.

Caso¬†voc√™¬†tenha¬†d√∫vidas¬†quanto¬†ao¬†que¬†s√£o¬†os¬†testes,¬†e¬†como¬†interpret√°-los,¬†d√™¬†uma¬†olhada¬†em¬†**[nosso¬†FAQ](https://www.notion.so/FAQ-Desafios-ddd8fcdf2339436a816a0d9e45767664)**

Para esse desafio, temos os seguintes testes:


* 1. **Teste components/Header/index.tsx**
[Teste components/Header/index.tsx](https://www.notion.so/Teste-components-Header-index-tsx-4c2e827e1b1246e9bbb4c63e6c4e7972)

- **should be able to render the amount of products added to cart**

Para que esse teste passe voc√™ deve renderizar o valor correto da quantidade de **tipos** de produtos 

```jsx
[
	{
	  amount: 2,
	  id: 1,
	  image:
	    'https://rocketseat-cdn.s3-sa-east-1.amazonaws.com/modulo-redux/tenis1.jpg',
	  price: 179.9,
	  title: 'T√™nis de Caminhada Leve Confort√°vel',
	},
	{
	  amount: 1,
	  id: 2,
	  image:
	    'https://rocketseat-cdn.s3-sa-east-1.amazonaws.com/modulo-redux/tenis2.jpg',
	  price: 139.9,
	  title: 'T√™nis VR Caminhada Confort√°vel Detalhes Couro Masculino',
	},
]
```

O valor correto a ser exibido √© `2 itens`.

* 2. **Testes pages/Home/index.tsx**
[Testes pages/Home/index.tsx](https://www.notion.so/Testes-pages-Home-index-tsx-8c9b60a771684f60baf9b9c4de5aa8a9)

- **should be able to render each product quantity added to cart**

    Para que esse teste passe voc√™ deve renderizar corretamente a quantidade adicionada de cada produto adicionado ao carrinho dentro da tag `<div data-testid="cart-product-quantity">`. Sugerimos criar uma vari√°vel `cartItemsAmount` utilizando o m√©todo `reduce` para iterar sobre os produtos adicionados ao `cart` e gerar um array com o `

    Sugerimos criar uma vari√°vel `cartItemsAmount` utilizando o m√©todo `reduce` para iterar sobre os produtos adicionados ao `cart` e gerar um array com o `id` do produto e a quantidade adicionada ao carrinho. Exemplo:

    ```jsx
    [
    	0: 0,
    	1: 2,
    	2: 4
    ]
    ```

    Mostraria a quantidade 0 para o produto de `id` 1, 2 para o de `id e 4 para o √∫ltimo.

- **should be able to add a product to cart**

    Para que esse teste passe voc√™ deve clicar no bot√£o `ADICIONAR AO CARRINHO` e o produto escolhido ser adicionado com sucesso ao carrinho. Al√©m disso, a quantidade do produto no carrinho mostrada no bot√£o deve representar o novo valor (incrementado de 1 unidade).

* 3. **Testes pages/Cart/index.tsx**
[Testes pages/Cart/index.tsx](https://www.notion.so/Testes-pages-Cart-index-tsx-20a8e0aa574b4a8a8a8a6462bc769094)

- **should be able to increase/decrease a product amount**

    Para que esse teste passe voc√™ deve renderizar corretamente o valor da quantidade de cada produto adicionado ao carrinho e ser capaz de incrementar e decrementar os valores ao clicar

    no bot√µes `<button *data-testid*="increment-product">` e `<button *data-testid*="decrement-product">` respect

- **should not be able to decrease a product amount when value is 1**

    Para que esse teste passe voc√™ deve desabilitar o bot√£o `<button*data-testid*="decrement-product">` quando a quantidade do produto for igual a 1.

- **shoud be able to remove a product**

    Para que esse teste passe voc√™ deve ser capaz de remover o produto do carrinho ao clicar no bot√£o `<button*data-testid*="remove-product">`

* 4. **Testes hooks/useCart.tsx**
[Testes hooks/useCart.tsx](https://www.notion.so/Testes-hooks-useCart-tsx-ee1a6dd59bf74599aa8cc518bcda4a17)

- **should be able to initialize cart with localStorage value**

    Para que esse teste passe voc√™ deve inicializar o estado `cart` com o valor da key `@RocketShoes:cart` do localStorage caso ele exista.

- **should be able to add a new product**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `addProduct` para adicionar um novo produto ao carrinho e preservar o valor atualizado do carrinho no localStorage utilizando o `setItem`.

- **should not be able add a product that does not exist**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `addProduct` para verificar que o produto n√£o existe, mostrar um `toast.error` com a mensagem `Erro na adi√ß√£o do produto` e sair da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

- **should be able to increase a product amount when adding a product that already exists on cart**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `addProduct` para incrementar em 1 unidade a quantidade de um produto no carrinho em vez de adicionar um novo produto. Deve tamb√©m preservar o valor atualizado do carrinho no localStorage utilizando o `setItem`.

- **should not be able to increase a product amount when running out of stock**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `addProduct` para verificar que a quantidade desejada do produto n√£o possui em estoque (rota `stock/id` da Fake API). Deve tamb√©m mostrar um `toast.error` com a mensagem `Quantidade solicitada fora de estoque` e sair da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

- **should be able to remove a product**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `removeProduct` para remover um produto do carrinho. Deve tamb√©m preservar o valor atualizado do carrinho no localStorage utilizando o `setItem`.

- **should not be able to remove a product that does not exist**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `removeProduct` para verificar que o produto n√£o existe no carrinho e mostrar um `toast.error` com a mensagem `Erro na remo√ß√£o do produto`. Deve tamb√©m sair da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

- **should be able to update a product amount**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `updateProductAmount` para incrementar e decrementar o valor de um produto no carrinho. Deve tamb√©m preservar o valor atualizado do carrinho no localStorage utilizando o `setItem`.

- **should not be able to update a product that does not exist**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `updateProductAmount` para verificar que o produto n√£o existe e mostrar um `toast.error` com a mensagem `Erro na altera√ß√£o de quantidade do produto`. Deve tamb√©m sair da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

- **should not be able to update a product amount when running out of stock**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `updateProductAmount` para verificar que a quantidade desejada do produto n√£o possui em estoque (rota `stock/id` da Fake API). Deve tamb√©m mostrar um `toast.error` com a mensagem `Quantidade solicitada fora de estoque` e sair da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

- **should not be able to update a product amount to a value smaller than 1**

    Para que esse teste passe voc√™ deve utilizar a fun√ß√£o `updateProductAmount` para verificar que a quantidade desejada do produto √© menor que 1 e sair imediatamente da fun√ß√£o sem alterar o `cart` e o valor no localStorage.

## Como deve ficar a aplica√ß√£o ao final?

Est√° com d√∫vidas (ou curioso üëÄ) para ver como deve ficar a aplica√ß√£o ao final do desafio? Deixamos abaixo um v√≠deo mostrando as principais funcionalidades que voc√™ deve implementar para te ajudar (ou matar sua curiosidade üëÄ).

[https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f166455c-a42f-4d25-8baa-a6686a3cb476/challenge.mp4](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f166455c-a42f-4d25-8baa-a6686a3cb476/challenge.mp4)

# üìÖ Entrega

Esse desafio deve ser entregue a partir da plataforma da Rocketseat. Envie o link do reposit√≥rio que voc√™ fez suas altera√ß√µes. Ap√≥s concluir o desafio, al√©m de ter mandado o c√≥digo para o GitHub, fazer um post no Linkedin √© uma boa forma de demonstrar seus conhecimentos e esfor√ßos para evoluir na sua carreira para oportunidades futuras.

# Solu√ß√£o do desafio

Caso voc√™ queira ver como resolver o desafio, fizemos um v√≠deo explicando o passo a passo para cumprir com todos os requisitos da aplica√ß√£o:

[https://youtu.be/NTeUIfUtKWw](https://youtu.be/NTeUIfUtKWw)

# Rodando todos os teste de todos os arquivos
    > yarn test

# Rodando todos os teste de um arquivo
    > yarn test src/__tests__/components/Header.spec.tsx

# Rodando teste por teste
    > yarn test -t 'should be able to initialize cart with localStorage value'